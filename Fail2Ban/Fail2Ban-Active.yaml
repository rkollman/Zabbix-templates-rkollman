zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 434806f8c92a4efd8d83e5b3d9ce6cec
      name: Kollman
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: 48d19098672f4e7aa7dab1942260d87d
      template: 'Fail2ban - Active'
      name: 'Fail2ban - Active'
      description: |
        Fail2Ban for Zabbix Active Agents, 
        
        This template is based on the Fail2Ban template by 
        Tomas Hermanek and published on (https://github.com/zabbix/community-templates/tree/main/Applications/Firewall/template_fail2ban)
        
        Make sure the following lines are saved as a UserParameter-file or as UserParameters in the Agent configuration:
        
        UserParameter=fail2ban.status[*],sudo /usr/bin/fail2ban-client status '$1' | grep 'Currently banned:' | grep -E -o '[0-9]+'
        UserParameter=fail2ban.discovery,sudo /usr/bin/fail2ban-client status | grep 'Jail list:' | sed -e 's/^.*:\W\+//' -e 's/\(\(\w\|-\)\+\)/{"{#JAIL}":"\1"}/g' -e 's/.*/{"data":[\0]}/'
        
        Also make sure that the Zabbix user has rights to execute fail2ban-client, this can for example be done by adding this to your sudo-configuration:
        
        zabbix ALL=NOPASSWD: /usr/bin/fail2ban-client status
        zabbix ALL=NOPASSWD: /usr/bin/fail2ban-client status *
        
        ## Author
        
        Raimond Kollman
      vendor:
        name: 'Raimond Kollman'
        version: 7.0-1
      groups:
        - name: Kollman
        - name: Templates/Applications
      items:
        - uuid: de416c540fd0435db1822e38c036f0d7
          name: 'Fail2Ban service is running'
          type: ZABBIX_ACTIVE
          key: 'proc.num[fail2ban-server]'
          history: 90d
          description: 'ping - tests if the server is alive'
          valuemap:
            name: 'Service state'
          tags:
            - tag: application
              value: fail2ban
          triggers:
            - uuid: ffa07343b51d4bf58c2b8c324c6a7a62
              expression: 'last(/Fail2ban - Active/proc.num[fail2ban-server])=0'
              name: 'Fail2ban server is Down'
              priority: AVERAGE
      discovery_rules:
        - uuid: ccbd8ba7a96d47b8953af017e3b0f803
          name: 'Fail2ban discovery'
          type: ZABBIX_ACTIVE
          key: fail2ban.discovery
          delay: 1h
          lifetime: 30d
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Discovery of jails from fail2ban daemon.'
          item_prototypes:
            - uuid: 8cc0b05211fc4278b2feb46727a4ca97
              name: 'Fail2ban {#JAIL} currently banned IPs'
              type: ZABBIX_ACTIVE
              key: 'fail2ban.status[{#JAIL}]'
              units: count
              description: 'The current banned IPs for a specific fail2ban jail'
              tags:
                - tag: application
                  value: fail2ban
              trigger_prototypes:
                - uuid: 5fb0112ea4f14b4fae1330e178f0721e
                  expression: 'avg(/Fail2ban - Active/fail2ban.status[{#JAIL}],10m)>{$FAIL2BANHIGH}'
                  name: 'Fail2ban {#JAIL} banned IPs high count last 10 minutes'
                  priority: HIGH
                  description: 'The average of banned IPs the last 10 minutes are more than {$FAIL2BANHIGH}'
                  tags:
                    - tag: scope
                      value: performance
                - uuid: cd8f015644964634b0eef6248e2ff451
                  expression: 'avg(/Fail2ban - Active/fail2ban.status[{#JAIL}],10m)>{$FAIL2BANWARN}'
                  name: 'Fail2ban {#JAIL} banned IPs warning count last 10 minutes'
                  priority: WARNING
                  description: 'The average of banned IPs the last 10 minutes are more than {$FAIL2BANWARN}'
                  dependencies:
                    - name: 'Fail2ban {#JAIL} banned IPs high count last 10 minutes'
                      expression: 'avg(/Fail2ban - Active/fail2ban.status[{#JAIL}],10m)>{$FAIL2BANHIGH}'
                  tags:
                    - tag: scope
                      value: performance
          graph_prototypes:
            - uuid: b151e34af81548b1b92cf0a6b36cdee7
              name: 'Number of banned IPs on jail {#JAIL}'
              graph_items:
                - color: 00C800
                  item:
                    host: 'Fail2ban - Active'
                    key: 'fail2ban.status[{#JAIL}]'
      macros:
        - macro: '{$FAIL2BANHIGH}'
          value: '10'
          description: 'High level for Fail2ban counts'
        - macro: '{$FAIL2BANWARN}'
          value: '5'
          description: 'Warning level for Fail2ban counts'
      valuemaps:
        - uuid: 249132609d114d21bf84a38a3c559bfd
          name: 'Service state'
          mappings:
            - value: '0'
              newvalue: Down
            - value: '1'
              newvalue: Up
